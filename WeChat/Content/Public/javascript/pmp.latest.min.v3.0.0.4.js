this.JSON||(this.JSON={}),function(){function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,i,s,r,o,h=gap,a=t[e];switch(a&&"object"==typeof a&&"function"==typeof a.toJSON&&(a=a.toJSON(e)),"function"==typeof rep&&(a=rep.call(t,e,a)),typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";if(gap+=indent,o=[],"[object Array]"===Object.prototype.toString.apply(a)){for(r=a.length,n=0;r>n;n+=1)o[n]=str(n,a)||"null";return s=0===o.length?"[]":gap?"[\n"+gap+o.join(",\n"+gap)+"\n"+h+"]":"["+o.join(",")+"]",gap=h,s}if(rep&&"object"==typeof rep)for(r=rep.length,n=0;r>n;n+=1)i=rep[n],"string"==typeof i&&(s=str(i,a),s&&o.push(quote(i)+(gap?": ":":")+s));else for(i in a)Object.hasOwnProperty.call(a,i)&&(s=str(i,a),s&&o.push(quote(i)+(gap?": ":":")+s));return s=0===o.length?"{}":gap?"{\n"+gap+o.join(",\n"+gap)+"\n"+h+"}":"{"+o.join(",")+"}",gap=h,s}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,n){var i;if(gap="",indent="","number"==typeof n)for(i=0;n>i;i+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw alert("error"),new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var n,i,s=e[t];if(s&&"object"==typeof s)for(n in s)Object.hasOwnProperty.call(s,n)&&(i=walk(s,n),void 0!==i?s[n]=i:delete s[n]);return reviver.call(e,t,s)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=arguments[1]||0;for(0>n&&(n+=t);t>n;n++)if(this[n]===e)return n;return-1}),Array.prototype.remove||(Array.prototype.remove=function(e){for(var t=0;t<this.length;t++)if(this[t]===e){for(var n=t;n<this.length;n++)this[n]=this[n+1];this.pop()}});var pmp={};pmp.Browser={MSIE:0,FF:0,Firebug:0,Safari:0,Opera:0,Chrome:0},navigator.userAgent.split("MSIE ")[1]&&(pmp.Browser.MSIE=navigator.userAgent.split("MSIE ")[1].slice(0,3)),navigator.userAgent.split("Firefox/")[1]&&(pmp.Browser.FF=navigator.userAgent.split("Firefox/")[1].slice(0,3)),navigator.userAgent.split(" Safari/")[1]&&(pmp.Browser.Safari=navigator.userAgent.split("/")[3].slice(0,3)),pmp.ConnectionStatus={Init:0,Active:1,Down:2,Reconnecting:3,Unauthorised:4,MaxClientsExceeded:5,TimeOut:6},pmp.Connection=function(e,t,n,i,s,r){this._version="v3.004 by Xu Jing (+86 13661510117)- Copyright Phillip Capital 2017",this._wsPublishServer="",this._PMPServerURI="",this._ws=null,this._sid=0,this._ping=15,this._destroyxed=0,this._connected=0,this._broken=0,this._now=0,this._lastTime=0,this._runInternal=1e3,this._recvClose=0,this._bcRecv=0,this._initConn=1,this._buffered=0,this._staleSet=0,this._runID=0,this._timerID=0,this._pingRequired=!0;var o=new Date;this._now=o.getTime(),this._lastTime=this._now,this._handlers=t||{},this._wsPublishServer=e,this._userName=n||"",this._password=i||"",this._sessionId=s||"",this._connectionId=r||"",this._subscribedCache=[],this._subscribingCache=[],this._unSubscribingCache=[],this._sendSubscribeId=0,this._sendSubscribeRequired=!1,this._login=!1,this._reset=0,this._sendPingInternal=30,this._HBTimeOut=1e4,this._resetTimeX=1e5,this._runInternalLapse=0,this._sendPingCounter=0,this._loginSuccessCounter=0,this._reloginCount=0},pmp.Connection.prototype.destroy=function(){this._destroyxed=1,this._connected=0,window.clearInterval(this._runID),window.clearTimeout(this._timerID),this._ws&&this._ws.close()},pmp.Connection.prototype.subscribeAll=function(){if(this._subscribedCache.length>0){this._handlers.debugHandler&&this._handlers.debugHandler(">subscribeAll."),this._unSubscribingCache=[],this._subscribingCache=[];for(var e=0;e<this._subscribedCache.length;e++)this._subscribingCache.push(this._subscribedCache[e]);this._sendSubscribeRequired=!0}},pmp.Connection.prototype.UpdateTpcArr=function(e,t){for(var n=0;n<e.length;n++)if(e[n].tpc==t.tpc)return void(e[n]=t);e.push(t)},pmp.Connection.prototype.RemoveTpcArr=function(e,t){for(var n=0;n<e.length;n++)if(e[n].tpc==t.tpc)return void e.splice(n,1)},pmp.Connection.prototype.subscribe=function(e){if(e)for(this._handlers.debugHandler&&this._handlers.debugHandler(">subscribe.");e.length>0;){var t=e.pop();this.UpdateTpcArr(this._subscribingCache,t),this.UpdateTpcArr(this._subscribedCache,t),this.RemoveTpcArr(this._unSubscribingCache,t)}this._sendSubscribeRequired=!0},pmp.Connection.prototype.unSubscribe=function(e){if(e){for(;e.length>0;){var t=e.pop();this.UpdateTpcArr(this._unSubscribingCache,t),this.RemoveTpcArr(this._subscribedCache,t),this.RemoveTpcArr(this._subscribingCache,t)}this._sendSubscribeRequired=!0}},pmp.Connection.prototype.sendSubscribe=function(){if(this._subscribingCache.length>0||this._unSubscribingCache.length>0){var e={};e.id="data",e.name=this._userName,e.sid=this._sessionId,e.cid=this._connectionId;for(var t=[];this._subscribingCache.length>0;){var n=this._subscribingCache.pop();n.enable=!0,t.push(n)}for(;this._unSubscribingCache.length>0;){var i=this._unSubscribingCache.pop();i.enable=!1,t.push(i)}e.sub=t,e.qry=null,this.post(e)}},pmp.Connection.prototype.query=function(e){if(e.length>0){var t={};t.id="data",t.name=this._userName,t.sid=this._sessionId,t.cid=this._connectionId,t.sub=null,t.qry=e,this.post(t)}},pmp.Connection.prototype.dbcquery=function(e,t,n){var i={};i.id="dbc",i.name=this._userName,i.sid=this._sessionId,i.cid=this._connectionId,i.tpc=e,i.cmd=t,i.cat=1,i.ver=1,i.body=n,this.post(i)},pmp.Connection.prototype.post=function(e){if(1!=this._ws.readyState)return this.connect();var t=JSON.stringify(e);this._ws.send(t)},pmp.Connection.prototype.init=function(e){if(this._sid=e.s,this._ping=e.p,this._recvClose=0,1===this._initConn){var t=this;setTimeout(function(){t.processConnect()},100)}else this._connected=1,this._broken=0,this._pingRequired=!0;this._lastTime=this._now},pmp.Connection.prototype.processConnect=function(){this._initConn=0,1===this._recvClose?(this._buffered=1,this._bcRecv=1):this._connected=1,this._broken=0,this._staleSet=0,this._pingRequired=!0,this._handlers.connectionStatusHandler&&this._handlers.connectionStatusHandler(pmp.ConnectionStatus.Active)},pmp.Connection.prototype.r=function(){this._handlers.debugHandler&&this._handlers.debugHandler("_r received."),this._pingRequired=!0,this._lastTime=this._now,this._reset=0},pmp.Connection.prototype.re=function(){this._handlers.debugHandler&&this._handlers.debugHandler("_re received."),this._pingRequired=!0,this._lastTime=this._now,this._reset=11},pmp.Connection.prototype.rb=function(){this._handlers.debugHandler&&this._handlers.debugHandler("_rb received."),this._lastTime=this._now,this._reset=1},pmp.Connection.prototype.h=function(){this._lastTime=this._now},pmp.Connection.prototype.p=function(){this._lastTime=this._now,this._pingRequired=!0},pmp.Connection.prototype.sendPing=function(){var e={};e.id="heartbeat",e.name=this._userName,e.sid=this._sessionId,e.cid=this._connectionId,this.post(e)},pmp.Connection.prototype.sendReset=function(){this._reset=2;var e={};e.id="reset",e.abort="false",e.name=this._userName,e.sid=this._sessionId,e.cid=this._connectionId,this.post(e)},pmp.Connection.prototype.l=function(e){if(this._handlers.debugHandler){var t="login received for "+JSON.stringify(e);this._handlers.debugHandler(t)}this._reset=0,"login"!=e.id&&"relogin"!=e.id||0!=e.rc?"login"!=e.id&&"relogin"!=e.id||17!=e.rc||!this._handlers.connectionStatusHandler?"login"!=e.id&&"relogin"!=e.id||0==e.rc||!this._handlers.connectionStatusHandler||this._handlers.connectionStatusHandler(pmp.ConnectionStatus.Unauthorised):this._handlers.connectionStatusHandler(pmp.ConnectionStatus.MaxClientsExceeded):(this._sessionId=e.sid,this._connectionId=e.cid,this._sendPingInternal=e.recv_timer,this._resetTimeX=1e3*e.reset_timer,this._HBTimeOut=1e3*e.send_timer_expire,this._runInternalLapse=this._runInternal/1e3,this._sendPingCounter=this._sendPingInternal,this.init({s:e.sid,p:15})),1==this._login&&this._handlers.loginHandler&&(this._login=!1,"login"==e.id&&0==e.rc&&(this._loginSuccessCounter+=1,this._loginSuccessCounter>1&&this.subscribeAll()),e.wsurl=this._wsPublishServer,this._handlers.loginHandler(e))},pmp.Connection.prototype.dbc=function(e){if(this._handlers.debugHandler){var t="dbc received as "+e+JSON.stringify(e);this._handlers.debugHandler(t)}this._handlers.dbcHandler&&this._handlers.dbcHandler(e)},pmp.Connection.prototype.q=function(e){if(this._handlers.debugHandler){var t="query received as "+JSON.stringify(e);this._handlers.debugHandler(t)}this._handlers.queryHandler&&this._handlers.queryHandler(e)},pmp.Connection.prototype.c=function(e){if(this._handlers.debugHandler){var t="subscribe confirm received as "+JSON.stringify(e);this._handlers.debugHandler(t)}if("login"==e.id&&0==e.rc&&(this._sessionId=e.sid,this._connectionId=e.cid),this._handlers.subscribeConfirmHandler&&this._handlers.subscribeConfirmHandler(e),e&&"data"==e.id)for(var n=0;n<e.val.length;n++)if(-1==e.val[n].day&&-1==e.val[n].page&&1==e.val[n].enable&&2!=e.val[n].rc){var i=this;this._timerID=setTimeout(function(){i.subscribeAll()},4200);break}this._pingRequired=!0},pmp.Connection.prototype.u=function(e){if(this._lastTime=this._now,this._handlers.debugHandler){var t="Update received as "+JSON.stringify(e);this._handlers.debugHandler("u:"+t)}if("login"==e.id&&0==e.rc&&(this._sessionId=e.sid,this._connectionId=e.cid),"data"==e.id)for(var n=0;n<e.val.length;n++)for(var i=0;i<e.val[n].item.length;i++)if("string"==typeof e.val[n].item[i].val)try{e.val[n].item[i].val=JSON.parse(pako.ungzip(atob(e.val[n].item[i].val).slice(4),{to:"string"}))}catch(s){}this._handlers.subscribeHandler&&this._handlers.subscribeHandler(e)},pmp.Connection.prototype.v=function(e){if(this._lastTime=this._now,this._handlers.debugHandler){var t="histiory Update received as "+JSON.stringify(e);this._handlers.debugHandler(t)}"login"==e.id&&0==e.rc&&(this._sessionId=e.sid,this._connectionId=e.cid),this._handlers.historySubscribeHandler&&this._handlers.historySubscribeHandler(e)},pmp.Connection.prototype.end=function(){if(this._handlers.debugHandler){var e="end received";this._handlers.debugHandler(e)}if(0===this._recvClose){this._connected=0,this._broken=1,this._buffered=0,this._sid=0;var t=this;this._timerID=setTimeout(function(){t.downCheck()},1e3)}else 1===this._buffered&&0===this._bcRecv&&(this._connected=0,this._broken=1,this._buffered=0,this._sid=0,t=this,this._timerID=setTimeout(function(){t.downCheck()},1e3));this._bcRecv=0},pmp.Connection.prototype.downCheck=function(){this._connected||this._buffered||(this._handlers.debugHandler&&this._handlers.debugHandler("Connection downCheck."),this._initConn=1,this._buffered=0,this._bcRecv=0,0===this._staleSet&&(this._staleSet=1,this._handlers.connectionStatusHandler&&this._handlers.connectionStatusHandler(pmp.ConnectionStatus.Down)),this._login=!0,this.connect())},pmp.Connection.prototype.reconnect=function(){this._handlers.debugHandler&&this._handlers.debugHandler("Reconnecting..."),this._reset=12,this._login=!1,this.connect()},pmp.Connection.prototype.sendClose=function(){0!==this._sid&&this.post({id:"close"})},pmp.Connection.prototype.run=function(){if(this._now=this._now+this._runInternal,1!==this._connected&&1!==this._buffered||0===this._sid)1==this._login&&this._now>this._lastTime+3*this._HBTimeOut&&(this._login=!1,this._handlers.debugHandler&&this._handlers.debugHandler("connecton time out."),this._handlers.connectionStatusHandler&&this._handlers.connectionStatusHandler(pmp.ConnectionStatus.TimeOut));else{if(this._now>this._lastTime+this._HBTimeOut){this._handlers.debugHandler&&(this._handlers.debugHandler("connecton idle time out."),this._handlers.debugHandler(this._now),this._handlers.debugHandler(this._lastTime)),this._broken=1,this._connected=0,this._recvClose=0,this._buffered=0;var e=this;return void(this._timerID=setTimeout(function(){e.downCheck()},4200))}if(1===this._reset)return void this.sendReset();if(11===this._reset)return void this.reconnect();if(12===this._reset&&this._now>this._lastTime+5*this._HBTimeOut)return void this.reconnect();if(this._sendSubscribeRequired===!0&&0===this._reset)return this._pingRequired===!0&&this._sendPingCounter>=this._sendPingInternal?(this.sendPing(),this._sendPingCounter=0):this._sendPingCounter=this._sendPingCounter+this._runInternalLapse,void this.sendSubscribe()}},pmp.Connection.prototype.start=function(){this._handlers.debugHandler&&this._handlers.debugHandler("login..."),this._login=!0,this.connect();var e=this;this._runID=setInterval(function(){e.run()},this._runInternal),this._handlers.debugHandler&&this._handlers.debugHandler("Started."),this._handlers.startedHandler&&this._handlers.startedHandler()},pmp.Connection.prototype.doMessage=function(e){var t=e.replace(/<script type=\"text\/javascript\">/g,"");t=t.replace(/<\/script>\r\n/g,"</script>");for(var n=t.split("</script>"),i=0;i<n.length;i++){var s=n[i].length;if(!(3>s)){var r=n[i].slice(0,2),o=n[i].slice(1,2);if("h("==r)this.h();else if("("==o){var h=n[i].slice(2,s-2),a=JSON.parse(h);"l("==r?this.l(a):"u("==r?this.u(a):"c("==r?this.c(a):"q("==r?this.q(a):"e("==r&&this.e(a)}}}},pmp.Connection.prototype.connect=function(){if(this._ws&&1==this._ws.readyState){if(this._now>this._lastTime+this._resetTimeX&&(this._sessionId=""),""===this._sessionId||this._reloginCount>3){this._reloginCount=0;var e={};e.id="login",e.name=this._userName,e.pwd=this._password,this.post(e)}else{this._reloginCount+=1;var t={};t.id="relogin",t.name=this._userName,t.sid=this._sessionId,t.cid=this._connectionId,this.post(t)}12!=this._reset&&this._handlers.connectionStatusHandler&&this._handlers.connectionStatusHandler(pmp.ConnectionStatus.Init)}else{var n=this;try{this._ws=new WebSocket(n._wsPublishServer),this._ws.onopen=function(){n.connect()},this._ws.onmessage=function(e){n.doMessage(e.data)},this._ws.onerror=function(){},this._ws.onclose=function(){1!=n._destroyxed&&n.end()}}catch(i){}}},function(){function e(e){t[e._wsPublishServer]=e}var t={};pmp.add_connectionByUserName=function(n,i,s,r){var o=t[n];return o?1:(o=new pmp.Connection(n,i,s,r),e(o),o.start(),0)},pmp.create_connectionByUserName=function(e,t,n,i){return pmp.add_connectionByUserName(e,t,n,i)},pmp.destroy_connection=function(){for(var e in t)t[e].destroy(),delete t[e]},pmp.destroy_connectionByUri=function(e){var n=t[e];n&&(n.destroy(),delete t[e])},pmp.set_connection_callbacks=function(e){for(var n in t)t[n]._handlers=e},pmp.subscribe=function(e,n){var i=t[n];i&&i.subscribe(e)},pmp.unSubscribe=function(e,n){var i=t[n];i&&i.unSubscribe(e)},pmp.query=function(e,n){var i=t[n];i&&i.query(e)},pmp.dbcquery=function(e,n,i,s){var r=t[s];r&&r.dbcquery(e,n,i)}}();